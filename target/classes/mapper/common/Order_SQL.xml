<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="order">

	<select id="orderMember" parameterType="hashmap" resultType="hashmap">
	<![CDATA[
	SELECT 
			M.MEMBER_NUMBER,
			M.MEMBER_ID,
			M.MEMBER_NAME,
			M.MEMBER_PHONE,
			M.MEMBER_EMAIL,
			M.MEMBER_ZIPCODE,
			M.MEMBER_ADDRESS1,
			M.MEMBER_ADDRESS2,
			M.MEMBER_REGDATE,
			M.MEMBER_DELDATE,
		SUM (P.POINT_POINT) MEMBER_POINT
		FROM MEMBER M, POINT P
		WHERE M.MEMBER_NUMBER = P.MEMBER_NUMBER
		AND M.MEMBER_NUMBER = ${MEMBER_NUMBER}
		GROUP BY 
			M.MEMBER_NUMBER, 
			M.MEMBER_ID, 
			M.MEMBER_NAME,
			M.MEMBER_PHONE,
			M.MEMBER_EMAIL,
			M.MEMBER_ZIPCODE,
			M.MEMBER_ADDRESS1,
			M.MEMBER_ADDRESS2,
			M.MEMBER_REGDATE,
			M.MEMBER_DELDATE
	]]>
	</select>

	<select id="orderGoods" parameterType="hashmap" resultType="hashmap">
	<![CDATA[
	select G.GOODS_NUMBER,
       G.GOODS_NAME,
       G.GOODS_PRICE,
       G.GOODS_DCPRICE,
       G.GOODS_THUMBNAIL,
       G.GOODS_SALEDATE,
       G.GOODS_COUNT,
       G.GOODS_RELATED,
       K.GOODS_NUMBER,
       K.GOODS_AMOUNT,
       K.GOODS_SIZE,
       K.GOODS_COLOR,
       K.GOODS_KINDS_NUMBER,
       G.GOODS_PRICE * ${EA} TOTALPRICE
       FROM GOODS G, GOODS_KINDS K
       WHERE G.GOODS_NUMBER = K.GOODS_NUMBER
       AND G.GOODS_NUMBER = ${GOODS_NUMBER}
       AND K.GOODS_KINDS_NUMBER = ${GOODS_KINDS_NUMBER}
	]]>
	</select>

	<insert id="insertMemberDelivery" parameterType="hashmap">
	<![CDATA[
	INSERT INTO DELIVERY 
	(ORDER_CODE,
	MEMBER_NUMBER,
	BUYER_ZIPCODE,
	BUYER_ADDRESS1,
	BUYER_ADDRESS2,
	BUYER_NAME,
	RECEIVER_NAME,
	BUYER_NUMBER,
	BUYER_EMAIL,
	RECEIVER_ZIPCODE,
	RECEIVER_ADDRESS1,
	RECEIVER_ADDRESS2,
	RECEIVER_NUMBER,
	DELIVERY_MESSAGE) VALUES 
	('${ORDER_CODE}',
	'${MEMBER_NUMBER}',
	'${BUYER_ZIPCODE}',
	'${BUYER_ADDRESS1}',
	'${BUYER_ADDRESS2}',
	'${BUYER_NAME}',
	'${RECEIVER_NAME}',
	'${BUYER_NUMBER}',
	'${BUYER_EMAIL}',
	'${RECEIVER_ZIPCODE}',
	'${RECEIVER_ADDRESS1}',
	'${RECEIVER_ADDRESS2}',
	'${RECEIVER_NUMBER}',
	'${DELIVERY_MESSAGE}')
	]]>
	</insert>

	<insert id="insertNonMemberDelivery" parameterType="hashmap">
	<![CDATA[
	INSERT INTO DELIVERY (
	ORDER_CODE,
	MEMBER_NUMBER,
	BUYER_ZIPCODE,
	BUYER_ADDRESS1,
	BUYER_ADDRESS2,
	BUYER_NAME,
	RECEIVER_NAME,
	BUYER_NUMBER,
	BUYER_EMAIL,
	GUEST_PASSWORD1,
	GUEST_PASSWORD2,
	RECEIVER_ZIPCODE,
	RECEIVER_ADDRESS1,
	RECEIVER_ADDRESS2,
	RECEIVER_NUMBER,
	DELIVERY_MESSAGE
	) VALUES (
	'${ORDER_CODE}',
	'${MEMBER_NUMBER}',
	'${BUYER_ZIPCODE}',
	'${BUYER_ADDRESS1}',
	'${BUYER_ADDRESS2}',
	'${BUYER_NAME}',
	'${RECEIVER_NAME}',
	'${BUYER_NUMBER}',
	'${BUYER_EMAIL}',
	'${GUEST_PASSWORD1}',
	'${GUEST_PASSWORD2}',
	'${RECEIVER_ZIPCODE}',
	'${RECEIVER_ADDRESS1}',
	'${RECEIVER_ADDRESS2}',
	'${RECEIVER_NUMBER}',
	'${DELIVERY_MESSAGE}'
	)
	]]>
	</insert>

	<insert id="insertOrderList" parameterType="hashmap">
	<![CDATA[
	INSERT INTO ORDERLIST (
	ORDER_NUMBER,
	MEMBER_NUMBER,
	GOODS_NUMBER,
	ORDER_CODE,
	ORDER_AMOUNT,
	ORDER_DATE,
	DELIVERY_STATE,
	GOODS_TOTAL,
	GOODS_PAY_STATE,
	GOODS_KINDS_NUMBER
	) VALUES (
	ORDER_NUMBER_SEQ.NEXTVAL,
	'${MEMBER_NUMBER}',
	'${GOODS_NUMBER}',
	'${ORDER_CODE}',
	'${ORDER_AMOUNT}',
	SYSDATE,
	'결제대기',
	'${GOODS_TOTAL}',
	'결제대기',
	'${GOODS_KINDS_NUMBER}'
	)
	]]>
	</insert>


	<!-- 세일 상품도 하기 -->

	<insert parameterType="hashmap" id="updatePoint">
		<![CDATA[
		INSERT INTO POINT (
			MEMBER_NUMBER,
			POINT_CONTENT,
			POINT_POINT,
			POINT_DATE,
			POINT_NUMBER)
		VALUES
			(#{MEMBER_NUMBER},
			 '상품 구매',
			 #{POINT_POINT},
			 SYSDATE,
			 POINT_NUMBER_SEQ.NEXTVAL)
		]]>
	</insert>
	<!-- 구매확정시 삼품 수량 삭제 만들어야 함 -->
	<update id="orderGoodsSell" parameterType="hashmap">
	<![CDATA[
	MERGE INTO GOODS_KINDS K
USING GOODS G
ON (K.GOODS_NUMBER = G.GOODS_NUMBER
AND K.GOODS_NUMBER = '${GOODS_NUMBER}'
AND K.GOODS_KINDS_NUMBER = '${GOODS_KINDS_NUMBER}')
WHEN MATCHED THEN
UPDATE SET K.GOODS_AMOUNT = K.GOODS_AMOUNT-'${ORDER_AMOUNT}',
K.GOODS_SELLCOUNT = K.GOODS_SELLCOUNT+'${ORDER_AMOUNT}'
	]]>
	</update>

	<!-- on되어있는 상품만, 등록 시간이 3일 이하인 상품만 -->
	<select id="selectCartOrder" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
			SELECT DISTINCT A.GOODS_NUMBER, A.CART_NUMBER, A.MEMBER_NUMBER,
			A.CART_REGDATE, A.CART_AMOUNT, A.GOODS_KINDS_NUMBER, E.GOODS_AMOUNT,
			E.GOODS_SIZE, E.GOODS_COLOR, E.GOODS_KINDS_NUMBER,
			D.GOODS_NAME, D.GOODS_PRICE, D.GOODS_DCPRICE, D.GOODS_SALEDATE,
			D.GOODS_THUMBNAIL,D.GOODS_CATEGORY1, D.GOODS_CATEGORY2
			FROM CART A, GOODS D, GOODS_KINDS E WHERE A.MEMBER_NUMBER=#{MEMBER_NUMBER}
			AND A.CART_REGDATE>SYSDATE-3
			AND A.GOODS_KINDS_NUMBER=E.GOODS_KINDS_NUMBER
			AND E.GOODS_KINDS_NUMBER=#{GOODS_KINDS_NUMBER}
			AND A.GOODS_NUMBER=D.GOODS_NUMBER AND D.GOODS_ONOFF=0
			ORDER BY A.CART_REGDATE DESC, A.GOODS_NUMBER ASC
		]]>
	</select>
	
		<select id="sessionCartList" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
			SELECT A.GOODS_NAME, A.GOODS_PRICE, A.GOODS_DCPRICE, A.GOODS_THUMBNAIL,
			A.GOODS_CATEGORY1, A.GOODS_CATEGORY2, A.GOODS_SALEDATE, A.GOODS_NUMBER,
			C.GOODS_AMOUNT, C.GOODS_SIZE, C.GOODS_COLOR, C.GOODS_KINDS_NUMBER
			FROM GOODS A, GOODS_KINDS C
			WHERE A.GOODS_NUMBER= #{GOODS_NUMBER} AND C.GOODS_KINDS_NUMBER=#{GOODS_KINDS_NUMBER}
			AND A.GOODS_ONOFF=0
		]]>
	</select>

</mapper>